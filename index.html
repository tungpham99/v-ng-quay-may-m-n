<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V√≤ng quay may m·∫Øn T·∫øt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== RESET & BACKGROUND ===== */
body{
    margin:0;
    height:100vh;
    font-family:system-ui;
    overflow:hidden;
    color:#fff;

    background:
        url("madao.png") no-repeat top center / contain,
        radial-gradient(circle at top,#1f2933,#020617);

    display:flex;
    justify-content:center;
    align-items:flex-end;
}

/* khung d·ªçc ki·ªÉu TikTok */
.app{
    width:100%;
    max-width:420px;
    height:100vh;
    display:flex;
    flex-direction:column;
    justify-content:flex-end;
    padding-bottom:20px;
    box-sizing:border-box;
}

/* khu v·ª±c v√≤ng quay */
.wheel-zone{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:16px;
}

/* ===== WHEEL RESPONSIVE ===== */
.wheel-container{
    position:relative;
    width:min(70vw, 420px);
    height:min(70vw, 420px);
    z-index:2;
}

canvas#wheel{
    display:block;
}

/* pointer */
.pointer{
    position:absolute;
    top:50%;
    right:-10px;
    transform:translateY(-50%) rotate(180deg);
    width:0;height:0;
    border-top:16px solid transparent;
    border-bottom:16px solid transparent;
    border-left:30px solid #fff;
}

/* ===== BUTTON ===== */
button{
    padding:12px 36px;
    font-size:16px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    background:linear-gradient(135deg,#f59e0b,#ef4444);
    color:#fff;
    font-weight:700;
}
button:active{
    transform:scale(.95);
}

/* ===== EFFECT CANVAS ===== */
canvas#fx{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:1;
}

/* ===== POPUP ===== */
.popup{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9;
    visibility:hidden;
}
.popup.show{ visibility:visible; }
.popup-box{
    background:#020617;
    padding:28px 32px;
    border-radius:16px;
    text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
}
</style>
</head>

<body>

<canvas id="fx"></canvas>

<div class="app">
    <div class="wheel-zone">
        <div class="wheel-container">
            <canvas id="wheel"></canvas>
            <div class="pointer"></div>
        </div>
        <button onclick="spin()">üßß QUAY üßß</button>
    </div>
</div>

<div class="popup" id="popup">
    <div class="popup-box">
        <h2 id="result"></h2>
        <button onclick="closePopup()">ƒê√≥ng</button>
    </div>
</div>

<script>
/* ===== AUDIO ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playFireSound(){
    const duration = 0.6;
    const sampleRate = 44100;
    const buffer = audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
    const data = buffer.getChannelData(0);

    for(let i = 0; i < data.length; i++){
        const t = i / sampleRate;

        // noise
        let noise = Math.random() * 2 - 1;

        // envelope: n·ªï m·∫°nh ƒë·∫ßu, t·∫Øt nhanh
        let env =
            (t < 0.02 ? t / 0.02 : 1) *   // attack 20ms
            Math.exp(-t * 8);            // decay nhanh

        data[i] = noise * env;
    }

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.8, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(
        0.001,
        audioCtx.currentTime + duration
    );

    src.connect(gain);
    gain.connect(audioCtx.destination);
    src.start();
}

/* ===== WHEEL SETUP RESPONSIVE ===== */
const wheel=document.getElementById("wheel");
const ctx=wheel.getContext("2d");
const container=document.querySelector(".wheel-container");
const dpr=devicePixelRatio||1;

let size, center, radius;

function resizeWheel(){
    size = container.offsetWidth;
    wheel.width = size * dpr;
    wheel.height = size * dpr;
    wheel.style.width = size+"px";
    wheel.style.height = size+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    center = size/2;
    radius = center;
    drawWheel();
}
window.addEventListener("resize", resizeWheel);

/* ===== DATA ===== */
const items=[
 {text:"10K",color:"#F59E0B",weight:40},
{text:"200K",color:"#3B82F6",weight:1},
 {text:"50K",color:"#EC4899",weight:18},
 {text:"100K",color:"#22C55E",weight:1},
 {text:"20K",color:"#F97316",weight:40},
 {text:"500K",color:"#60A5FA",weight:0}
];

const slice=2*Math.PI/items.length;
let angle=0;
let spinning=false;

/* ===== DRAW ===== */
function drawWheel(){
    ctx.clearRect(0,0,size,size);

    ctx.beginPath();
    ctx.arc(center,center,radius,0,Math.PI*2);
    ctx.fillStyle="#facc15";
    ctx.fill();

    for(let i=0;i<28;i++){
        const a=(Math.PI*2/28)*i;
        const x=center+Math.cos(a)*(radius-8);
        const y=center+Math.sin(a)*(radius-8);
        ctx.beginPath();
        ctx.arc(x,y,4,0,Math.PI*2);
        ctx.fillStyle=i%2?"#fff":"#fde68a";
        ctx.fill();
    }

    items.forEach((it,i)=>{
        const a=angle+i*slice;
        ctx.beginPath();
        ctx.moveTo(center,center);
        ctx.arc(center,center,radius-18,a,a+slice);
        ctx.fillStyle=it.color;
        ctx.fill();

        ctx.save();
        ctx.translate(center,center);
        ctx.rotate(a+slice/2);
        ctx.fillStyle="#fff";
        ctx.font="bold 20px system-ui";
        ctx.textAlign="right";
        ctx.textBaseline="middle";
        ctx.shadowColor="rgba(0,0,0,.5)";
        ctx.shadowBlur=4;
        ctx.fillText(it.text,radius-40,0);
        ctx.restore();
    });

    ctx.beginPath();
    ctx.arc(center,center,36,0,Math.PI*2);
    ctx.fillStyle="#dc2626";
    ctx.fill();
    ctx.beginPath();
    ctx.arc(center,center,30,0,Math.PI*2);
    ctx.fillStyle="#ef4444";
    ctx.fill();
}
function playTickSound(){
    const duration = 0.03;
    const sampleRate = 44100;
    const buffer = audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
    const data = buffer.getChannelData(0);

    for(let i=0;i<data.length;i++){
        // click kh√¥, g·ªçn
        data[i] = (Math.random()*2-1) * Math.exp(-i/(sampleRate*0.01));
    }

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const gain = audioCtx.createGain();
    gain.gain.value = 0.25;

    src.connect(gain);
    gain.connect(audioCtx.destination);
    src.start();
}
function launchFirework(side){
    fireworks.push({
        x:side==="L"?0:fx.width,
        y:fx.height,
        vx:side==="L"?Math.random()*3+4:-(Math.random()*3+4),
        vy:-(Math.random()*8+12),
        trail:[],
        exploded:false,
        color:`hsl(${Math.random()*360},100%,60%)`
    });
}
function explode(f){
    const count = 48;
    for(let i=0;i<count;i++){
        const a = (Math.PI*2/count)*i;
        const speed = Math.random()*3 + 3; // m·∫°nh h∆°n
        fireworks.push({
            x:f.x,
            y:f.y,
            vx:Math.cos(a)*speed,
            vy:Math.sin(a)*speed,
            life:60,
            exploded:true,
            color:f.color
        });
    }
}

/* ===== SPIN ===== */
function pickIndex(){
    let t=items.reduce((s,i)=>s+i.weight,0);
    let r=Math.random()*t;
    for(let i=0;i<items.length;i++){
        r-=items[i].weight;
        if(r<=0) return i;
    }
    return 0;
}

function spin(){
      if(spinning) return;
    spinning = true;
    audioCtx.resume();


    angle = angle % (Math.PI * 2);

    const idx = pickIndex();
    const start = angle;

    const extraRounds = 5; 
    let end =
        extraRounds * Math.PI * 2
        - (slice * idx + slice / 2);

    while(end <= start){
        end += Math.PI * 2;
    }

    let t0 = null;

    function anim(t){
        if(!t0) t0 = t;
        const p = Math.min((t - t0) / 6000, 1);

        angle = start + (end - start) * (1 - Math.pow(1 - p, 3));

        drawWheel();
        spawnLucky();
        playTickSound();
        if(p < 1){
            requestAnimationFrame(anim);
        } else {
            spinning = false;

            angle = end % (Math.PI * 2);

            result.innerText = "üéâ B·∫°n ƒë∆∞·ª£c l√¨ x√¨: " + items[idx].text;
            popup.classList.add("show");
        }
    }

    requestAnimationFrame(anim);
}

function closePopup(){
    popup.classList.remove("show");
}

/* ===== FX ===== */
const fx=document.getElementById("fx");
const fctx=fx.getContext("2d");
fx.width=innerWidth; fx.height=innerHeight;
addEventListener("resize",()=>{fx.width=innerWidth;fx.height=innerHeight;});

const petals=[],fireworks=[],lucky=[];

function spawnPetal(){
    petals.push({
        x:Math.random()*fx.width,y:-20,
        vx:Math.random()-0.5,vy:Math.random()*2+2,
        r:Math.random()*Math.PI,
        icon:Math.random()>0.5?"üå∏":"üåº"
    });
}
function spawnLucky(){
    lucky.push({
        x:fx.width/2,y:fx.height-280,
        vx:(Math.random()-0.5)*6,vy:(Math.random()-1)*6,life:60
    });
}

function animateFX(){
  
    fctx.clearRect(0,0,fx.width,fx.height);
    fctx.clearRect(0,0,fx.width,fx.height);

    if(Math.random()<0.12) spawnPetal();
    if(Math.random()<0.025){
        launchFirework("L");
        launchFirework("R");
    }
    petals.forEach((p,i)=>{
        p.x+=p.vx; p.y+=p.vy; p.r+=0.01;
        fctx.save();
        fctx.translate(p.x,p.y); fctx.rotate(p.r);
        fctx.font="22px serif"; fctx.fillText(p.icon,0,0);
        fctx.restore();
        if(p.y>fx.height) petals.splice(i,1);
    });

    lucky.forEach((l,i)=>{
        l.x+=l.vx; l.y+=l.vy; l.life--;
        fctx.font="24px serif";
        fctx.fillText("üßß",l.x,l.y);
        if(l.life<=0) lucky.splice(i,1);
    });
     fireworks.forEach((f,i)=>{
    if(!f.exploded){
        f.trail.push({x:f.x,y:f.y});
        if(f.trail.length>10) f.trail.shift();

        f.x += f.vx;
        f.y += f.vy;

        // ki·ªÉm tra ƒë·ªânh
        const prevVy = f.vy;
        f.vy += 0.25;

        fctx.strokeStyle = f.color;
        fctx.beginPath();
        f.trail.forEach((t,j)=>j?fctx.lineTo(t.x,t.y):fctx.moveTo(t.x,t.y));
        fctx.stroke();

        // üí• n·ªï NGAY khi v·ª´a ch·∫°m ƒë·ªânh
        if(prevVy < 0 && f.vy >= 0){
            explode(f);
            playFireSound();   // üîä ti·∫øng n·ªï kh·ªõp h√¨nh
            fireworks.splice(i,1);
        }
    }else{
        f.x += f.vx;
        f.y += f.vy;
        f.vy += 0.05;
        f.life--;

        fctx.fillStyle = f.color;
        fctx.fillRect(f.x,f.y,2,2);

        if(f.life<=0) fireworks.splice(i,1);
    }
});


    requestAnimationFrame(animateFX);
}

resizeWheel();
animateFX();
</script>
</body>
</html>
